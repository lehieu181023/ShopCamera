@model Product
@using System.Globalization
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
}

<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6 wow fadeInUp" data-wow-delay="0.1s">Tên sản phẩm</h1>
    <ol class="breadcrumb justify-content-center mb-0 wow fadeInUp" data-wow-delay="0.3s">
        <li class="breadcrumb-item"><a >Trang chủ</a></li>
        <li class="breadcrumb-item"><a >Trang</a></li>
        <li class="breadcrumb-item active text-white">Tên sản phẩm</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Single Products Start -->
<div class="container-fluid shop py-5">
    <div class="container py-5">
        <div class="row g-4">
            <div class="col-lg-5 col-xl-3 wow fadeInUp" data-wow-delay="0.1s">
                @* <div class="input-group w-100 mx-auto d-flex mb-4">
                    <input type="search" class="form-control p-3" placeholder="keywords"
                           aria-describedby="search-icon-1">
                    <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                </div>
                <div class="product-categories mb-4">
                    <h4>Danh mục sản phẩm</h4>
                    <ul class="list-unstyled">
                        <li>
                            <div class="categories-item">
                                <a  class="text-dark">
                                    <i class="fas fa-apple-alt text-secondary me-2"></i>
                                    Router WiFi & Bộ phát sóng
                                </a>
                                <span>(3)</span>
                            </div>
                        </li>
                        <li>
                            <div class="categories-item">
                                <a  class="text-dark">
                                    <i class="fas fa-apple-alt text-secondary me-2"></i>
                                    Camera An Ninh
                                </a>
                                <span>(5)</span>
                            </div>
                        </li>
                        <li>
                            <div class="categories-item">
                                <a  class="text-dark">
                                    <i class="fas fa-apple-alt text-secondary me-2"></i>Đầu ghi & Lưu trữ
                                </a>
                                <span>(2)</span>
                            </div>
                        </li>
                        <li>
                            <div class="categories-item">
                                <a  class="text-dark">
                                    <i class="fas fa-apple-alt text-secondary me-2"></i>Phụ kiện mạng & camera
                                </a>
                                <span>(8)</span>
                            </div>
                        </li>
                        <li>
                            <div class="categories-item">
                                <a  class="text-dark">
                                    <i class="fas fa-apple-alt text-secondary me-2"></i>Combo & Giải pháp trọn gói
                                </a>
                                <span>(5)</span>
                            </div>
                        </li>
                    </ul>
                </div> *@
                <div id="featuredProduct"></div>
                @* <a >
                    <div class="position-relative">
                        <img src="img/product-banner-2.jpg" class="img-fluid w-100 rounded" alt="Image">
                        <div class="text-center position-absolute d-flex flex-column align-items-center justify-content-center rounded p-4"
                             style="width: 100%; height: 100%; top: 0; right: 0; background: rgba(242, 139, 0, 0.3);">
                            <h5 class="display-6 text-primary">Giảm giá</h5>
                            <h4 class="text-secondary">Có thể lên tới 50%</h4>
                            <a  class="btn btn-primary rounded-pill px-4">Mua ngay</a>
                        </div>
                    </div>
                </a> *@
            </div>
            <div class="col-lg-7 col-xl-9 wow fadeInUp" data-wow-delay="0.1s">
                <div class="row g-4 single-product">
                    <div class="col-xl-6">
                        <div class="single-carousel owl-carousel">
                            <div class="single-item" data-dot="<img class='img-fluid' src='@Model.MainImage' alt=''>">
                                <div class="single-inner bg-light rounded">
                                    <img src="@Model.MainImage" class="img-fluid rounded" alt="Hình ảnh">
                                </div>
                            </div>
                            @* <div class="single-item" data-dot="<img class='img-fluid' src='img/product-5.png' alt=''>">
                                <div class="single-inner bg-light rounded">
                                    <img src="img/product-5.png" class="img-fluid rounded" alt="Hình ảnh">
                                </div>
                            </div>
                            <div class="single-item" data-dot="<img class='img-fluid' src='img/product-6.png' alt=''>">
                                <div class="single-inner bg-light rounded">
                                    <img src="img/product-6.png" class="img-fluid rounded" alt="Hình ảnh">
                                </div>
                            </div>
                            <div class="single-item" data-dot="<img class='img-fluid' src='img/product-7.png' alt=''>">
                                <div class="single-inner bg-light rounded">
                                    <img src="img/product-7.png" class="img-fluid rounded" alt="Hình ảnh">
                                </div>
                            </div>
                            <div class="single-item" data-dot="<img class='img-fluid' src='img/product-3.png' alt=''>">
                                <div class="single-inner bg-light rounded">
                                    <img src="img/product-3.png" class="img-fluid rounded" alt="Hình ảnh">
                                </div>
                            </div> *@
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <h4 class="fw-bold mb-3">@Model.ProductName</h4>
                        <p class="mb-3">Danh mục: @Model.Category.CategoryName</p>
                        <h5 class="fw-bold mb-3">@String.Format(new CultureInfo("vi-VN"), "{0:C0}", Model.SellingPrice)</h5>
                        <div class="d-flex mb-4">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if(Model.RatingCount <= 0)
                                {
                                    Model.RatingScore = 5;
                                }
                                if (i <= Model.RatingScore)
                                {
                                    <i class="fa fa-star text-secondary"></i>
                                }
                                else
                                {
                                    <i class="fa fa-star"></i>
                                }
                            }
                        </div>
                        @* <div class="mb-3">
                            <div class="btn btn-primary d-inline-block rounded text-white py-1 px-4 me-2">
                                <i class="fab fa-facebook-f me-1"></i> Chia sẻ
                            </div>
                            <div class="btn btn-secondary d-inline-block rounded text-white py-1 px-4 ms-2">
                                <i class="fab fa-twitter ms-1"></i> Chia sẻ
                            </div>
                        </div> *@
                        <div class="d-flex flex-column mb-3">
                            <small>Mã sản phẩm (SKU): @Model.ProductCode</small>
                            <small>Tình trạng: <strong class="text-primary">Còn @Model.StockQuantity sản phẩm trong kho</strong></small>
                        </div>
                        <p class="mb-4" style="white-space:nowrap">@Model.ShortDescription</p>
                        <div class="input-group quantity mb-5" style="width: 100px;">
                            <div class="input-group-btn">
                                <button class="btn btn-sm btn-minus rounded-circle bg-light border">
                                    <i class="fa fa-minus"></i>
                                </button>
                            </div>
                            <input type="text" id="quantity" class="form-control form-control-sm text-center border-0" value="1">
                            <div class="input-group-btn">
                                <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <a onclick="addToCart(@Model.Id,$('#quantity').val())"
                           class="btn btn-primary border border-secondary rounded-pill px-4 py-2 mb-4 text-primary">
                            <i class="fa fa-shopping-bag me-2 text-white"></i> Thêm vào giỏ hàng
                        </a>
                    </div>
                    <div class="col-lg-12">
                        <nav>
                            <div class="nav nav-tabs mb-3">
                                <button class="nav-link active border-white border-bottom-0" type="button"
                                        role="tab" id="nav-about-tab" data-bs-toggle="tab" data-bs-target="#nav-about"
                                        aria-controls="nav-about" aria-selected="true">
                                    Mô tả
                                </button>
                                <button class="nav-link border-white border-bottom-0" type="button" role="tab"
                                        id="nav-mission-tab" data-bs-toggle="tab" data-bs-target="#nav-mission"
                                        aria-controls="nav-mission" aria-selected="false">
                                    Đánh giá
                                </button>
                            </div>
                        </nav>
                        <div class="tab-content mb-5">
                            <div class="tab-pane active" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab">
                                <p class="mb-4" style="white-space:nowrap">@Model.DetailedDescription</p>
                            </div>
                            <div class="tab-pane" id="nav-mission" role="tabpanel" aria-labelledby="nav-mission-tab">
                                @{
                                    var reviews = ViewData["Reviews"] as List<CameraTuanA.Models.ProductReview>;
                                    var rand = new Random();
                                }

                                @if (reviews != null && reviews.Count > 0)
                                {
                                    foreach (var r in reviews)
                                    {
                                        var name = r.Account.FullName ?? "Người dùng";
                                        var firstChar = name.Substring(0, 1).ToUpper();
                                        var colorIndex = rand.Next(1, 7); // 6 màu nền khác nhau
                                                                          <div class="d-flex mb-4 align-items-start review-item">
                                                                              <!-- Avatar -->
                                                                              <div class="avatar-circle text-white fw-bold d-flex align-items-center justify-content-center me-3 bg-color-@colorIndex"
                                                                                   style="width: 100px; height: 100px; border-radius: 50%; font-size: 36px;">
                                                                                  @firstChar
                                                                              </div>

                                            <!-- Nội dung -->
                                            <div>
                                                <p class="mb-2" style="font-size: 14px;">
                                                    @(r.ReviewedAt?.ToString("dd 'Tháng' MM, yyyy"))
                                                </p>

                                                <div class="d-flex justify-content-between">
                                                    <h5>@name</h5>
                                                    <div class="d-flex mb-3">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (i <= r.RatingScore)
                                                            {
                                                                <i class="fa fa-star text-secondary"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="fa fa-star"></i>
                                                            }
                                                        }
                                                    </div>
                                                </div>

                                                <p>@r.ReviewContent</p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                                }

                            </div>
                        </div>
                    </div>
                    <form id="reviewForm">
                        <h4 class="mb-5 fw-bold">Để lại đánh giá</h4>
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <div class="border-bottom rounded my-4">
                                    <textarea class="form-control border-0" name="Content"
                                              cols="30" rows="5" placeholder="Nội dung đánh giá *" required></textarea>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="d-flex justify-content-between py-3 mb-5 align-items-center">
                                    <div class="d-flex align-items-center">
                                        <p class="mb-0 me-3">Vui lòng đánh giá:</p>
                                        <div id="starRating" class="d-flex align-items-center" style="font-size: 18px; cursor: pointer;">
                                            <i class="fa fa-star text-muted" data-star="1"></i>
                                            <i class="fa fa-star text-muted" data-star="2"></i>
                                            <i class="fa fa-star text-muted" data-star="3"></i>
                                            <i class="fa fa-star text-muted" data-star="4"></i>
                                            <i class="fa fa-star text-muted" data-star="5"></i>
                                        </div>
                                    </div>

                                    <button type="button" id="btnSubmitReview"
                                            class="btn btn-primary border border-secondary text-primary rounded-pill px-4 py-3">
                                        Gửi đánh giá
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>
<!-- Single Products End -->
<!-- Related Product Start -->
<div id="relatedProduct"></div>
<!-- Related Product End -->
<style>
    .bg-color-1 {
        background-color: #6C63FF;
    }

    .bg-color-2 {
        background-color: #00BFA6;
    }

    .bg-color-3 {
        background-color: #FF6F61;
    }

    .bg-color-4 {
        background-color: #F9A826;
    }

    .bg-color-5 {
        background-color: #0096C7;
    }

    .bg-color-6 {
        background-color: #9B5DE5;
    }
</style>

@section Scripts {
    <script>
        let selectedStar = 0;

        // chọn sao
        $(document).on('click', '#starRating i', function () {
            selectedStar = parseInt($(this).data('star'));
            $('#starRating i').each(function () {
                const star = $(this).data('star');
                $(this).toggleClass('text-warning', star <= selectedStar);
                $(this).toggleClass('text-muted', star > selectedStar);
            });
        });

        // gửi form
        $('#btnSubmitReview').on('click', function () {
            const form = $('#reviewForm');
            const data = {
                ProductId: @Model.Id,
                ReviewContent: form.find('textarea[name="Content"]').val(),
                RatingScore: selectedStar
            };

            if (data.Rating === 0) {
                alert("Vui lòng chọn số sao!");
                return;
            }

            $.ajax({
                url: '/Product/Review',
                type: 'POST',
                data: data,
                success: function (res) {
                    if (res.success) {
                        alert("Cảm ơn bạn đã gửi đánh giá!");
                        location.reload();
                    } else {
                        alert(res.message || "Có lỗi xảy ra!");
                    }
                },
                error: function () {
                    alert("Không thể gửi đánh giá. Vui lòng thử lại!");
                }
            });
        });


    </script>
    <script>
        $(function() {
            $("#featuredProduct").load("/Product/featuredProduct");
        });
        $("#relatedProduct").load("/Product/relatedProduct/@Model.Id", function () {
            $(".related-carousel").owlCarousel({
                items: 4,
                loop: true,
                autoplay: true,
                margin: 15,
                dots: true,
                nav: false
            });
            new WOW().init();
        });

    </script>
}